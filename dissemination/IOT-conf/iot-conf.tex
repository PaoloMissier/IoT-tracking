\documentclass[chi_draft]{sigchi}

% Use this section to set the ACM copyright statement (e.g. for
% preprints).  Consult the conference website for the camera-ready
% copyright statement.

% Copyright
\CopyrightYear{2017}
%\setcopyright{acmcopyright}
\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\setcopyright{usgov}
%\setcopyright{usgovmixed}
%\setcopyright{cagov}
%\setcopyright{cagovmixed}
% DOI
\doi{http://dx.doi.org/10.475/123_4}
% ISBN
\isbn{123-4567-24-567/08/06}
%Conference
\conferenceinfo{IoT}{...}
%Price
\acmPrice{\$15.00}

% Use this command to override the default ACM copyright statement
% (e.g. for preprints).  Consult the conference website for the
% camera-ready copyright statement.

%% HOW TO OVERRIDE THE DEFAULT COPYRIGHT STRIP --
%% Please note you need to make sure the copy for your specific
%% license is used here!
% \toappear{
% Permission to make digital or hard copies of all or part of this work
% for personal or classroom use is granted without fee provided that
% copies are not made or distributed for profit or commercial advantage
% and that copies bear this notice and the full citation on the first
% page. Copyrights for components of this work owned by others than ACM
% must be honored. Abstracting with credit is permitted. To copy
% otherwise, or republish, to post on servers or to redistribute to
% lists, requires prior specific permission and/or a fee. Request
% permissions from \href{mailto:Permissions@acm.org}{Permissions@acm.org}. \\
% \emph{CHI '16},  May 07--12, 2016, San Jose, CA, USA \\
% ACM xxx-x-xxxx-xxxx-x/xx/xx\ldots \$15.00 \\
% DOI: \url{http://dx.doi.org/xx.xxxx/xxxxxxx.xxxxxxx}
% }

% Arabic page numbers for submission.  Remove this line to eliminate
% page numbers for the camera ready copy
% \pagenumbering{arabic}



\input{preamble}

\begin{document}
%
% paper title
% Titles are generally capitalized except for words such as a, an, and, as,
% at, but, by, for, in, nor, of, on, or, the, to and up, which are usually
% not capitalized unless they are the first or last word of the title.
% Linebreaks \\ can be used within to get better formatting as desired.
% Do not put math or special symbols in the title.
\title{Mind My Value: a decentralized infrastructure for fair and trusted IoT data pricing}


%\title{\plaintitle}

\numberofauthors{5}
\emptyauthor
%\author{%
%	\alignauthor{Paolo Missier\\
%		\affaddr{Newcastle University}\\
%		\affaddr{Newcastle, UK}\\
%		\email{paolo.missier@newcastle.ac.uk}}\\
%	\alignauthor{Michele Nati\\
%		\affaddr{Digital Catapult}\\
%		\affaddr{London, UK}\\
%		\email{michele.nati@digicatapult.org.uk}}\\
%	\alignauthor{Angelo Capossele\\
%		\affaddr{Digital Catapult}\\
%		\affaddr{London, UK}\\
%		\email{Angelo.Capossele@digicatapult.org.uk}}\\
%	\alignauthor{Andrea Gaglione\\
%	\affaddr{Digital Catapult}\\
%	\affaddr{London, UK}\\
%	\email{Andrea.Gaglione@digicatapult.org.uk}}\\
%	\alignauthor{Shaimaa Bajoudah\\
%	\affaddr{Newcastle University}\\
%	\affaddr{Newcastle, UK}\\
%	\email{S.Bajoudah1@newcastle.ac.uk}}\\
%}


% make the title area
\maketitle

% As a general rule, do not put math, special symbols or citations
% in the abstract
\begin{abstract}
The abstract goes here.
\end{abstract}




\section{Introduction}

Individuals who own and operate IoT edge devices (wearables, smart home etc) should be able to retain some control over the data that is continuously generated by those devices.
Increasingly, such data are considered valuable digital assets that could be traded with third parties:  ``There are third parties that could benefit from using that data, and the challenge is in allowing them to access it under the conditions that data owners find acceptable.'' \note{[Misura, Kresimir, and Mario Zagar. 2016]}

\note{remove this ref from here -- it is now in related work}

\textcolor{blue}{Data producers} may be, for example, wearables (accelerometers, glucose monitors, heart monitors, smart energy meters in the home), personal, vehicle or home monitoring sensors, etc.
These IoT devices generate various types of data streams, at different rates, which may be of interest to a variety of consumers, typically analytics applications that may operate over data that is aggregated from multiple streams and over time, or on a per-individual basis.
We refer to these consumers generically as Value Added Services (VAS).

In the health sector, for example, individuals' activity levels and fitness data, as recorded by smart phones or dedicated fitness devices, may be of interest to health care providers as well as health insurance companies, even if only in anonymised and aggregate form.
%
In public transport, the density of personal travel card swipes over time at individual metro stations in London will be %of interest
useful not only to the transportation authority, but also to taxi companies%who need to decide how to position their cars outside metro stations, i.e., in situations where passenger traffic patterns deviate from the predictable norm.
. Therefore, the latter might be interested in buying such data together with footfall data--collected, for example, through an IoT infrastructure--and leverage them to decide how to position their cars outside metro stations, i.e., in situations where passenger traffic patterns deviate from the predictable norm.
%
 Similarly, aggregate smart metering is shown to enable providers to optimise the delivery of commodity services, eg water, energy.  \note{CITE}.
%
As a final \textcolor{blue}{sports} example, today it is possible to quantify an athlete's effort during a competition using a number of wearable devices, from bio-harness to accelerometers, to video feeds. 
It is easy to imagine that, in the near future, athletes may be able to license these feeds to followers who are interested in tracking their competition online.

Underlying all these examples is the emergent idea that data streams produced by IoT devices that belong to individuals or organisations are increasingly viewed as \textit{tradeable assets} with a potential market value associated to a secondary use of such data.
%
Indeed,  a number of models are emerging on how to price online data, and data marketplaces already exist in a number of scenarios \note{CITE}.
%
In this paper, %we explore the idea of a 
we envision a marketplace specifically for IoT data, which enables device owners not only to control the distribution of the data produced by their devices, but also to trade them with third parties.\ag{wrt Michele's note, I don't think we ``explore some of the building blocks'', rather we ``explore possible architectural models and propose a reference architecture'' }
%
\textcolor{blue}{Specifically, we focus on a ``IoT Big Data trading'' scenario where high Velocity, high Volume and potentially high Variety data streams flow from IoT edge devices, the producers, to VAS, typically embodied as cloud services located in the core network.}\ag{IMHO the last sentence can be completely removed.}
As in any marketplace, IoT data trading should be governed by an agreed-upon set of rules, set in advance, which determine what kinds of contract and transactions are acceptable, and stipulate sanctions when the rules are violated.
%
While we acknowledge that contractual agreements must be stipulated between %the 
individuals or organisations that own or control the devices and the VASs, in this work we %are only concerned with the study of 
focus on the underpinning technology that %makes it possible to realise 
enable IoT data trading by enhancing the current IoT infrastructure%regardless of specific pricing and contract models.,
, and analyse its feasibility by quantifying the actual value of both data and transactions. 

The main novel element of our work is that we challenge the common assumption that a marketplace must be controlled by a trusted authority, in charge of certifying the identity of the participants%, 
 and ensuring %fairness.
fair value distribution. 
In particular, data brokers typically play the role of trusted network components that are controlled by a marketplace authority.
%
In contrast, we envision a decentralised and self-regulating marketplace where rules are automatically enforced, fairness of the transactions guaranteed, and sanctions imposed in response to violations.
%

\note{use this to refer to emerging business models for data marketplaces -- \cite{Stahl2016} Stahl, F., Schomm, F., Vossen, G., \& Vomfell, L. (2016). A classification framework for data marketplaces. Vietnam Journal of Computer Science, 3(3), 137–143. https://doi.org/10.1007/s40595-016-0064-2}

\note{\cite{7004800} Perera, C., Liu, C. H.,\& Jayawardena, S. (2015). The Emerging Internet of Things Marketplace From an Industrial Perspective: A Survey. IEEE Transactions on Emerging Topics in Computing, 3(4), 585–598. https://doi.org/10.1109/TETC.2015.2390034\\
	A comprehensive survey of industry-ready IoT technology -- good to support the claim that there are a lot of sensor types out there, but ``marketplace''  here just means, HW that is on the market...}

%
An 2012 survey of data vendors \cite{Schomm2013} includes 46 data suppliers. While the definition of data marketplace used in the paper is generic (``a platform on which anybody can upload and maintain data sets, with license-regulated access to and use of the data'') and geared towards static data, like Microsoft's Azure Data Market, it should be possible to extend the classification of marketplace types to \textit{data in movement}, and IoT data streams in particular, which is our focus.

\note{general background -- can't find a place for this, it's one of many possible examples. \cite{7113786} Islam, S. M. R., Kwak, D., Kabir, M. H., Hossain, M., \& Kwak, K. S. (2015). The Internet of Things for Health Care: A Comprehensive Survey. IEEE Access, 3, 678–708. https://doi.org/10.1109/ACCESS.2015.2437951}

\subsection{Contributions}\ag{This should be included the previous section}

%In the rest of the paper we present our approach to addressing some of the challenges that emerge when trying to realise such a trust-less IoT data marketplace.

%Our first contribution is a data architecture for tracking data flows through brokers, using a publish-subscribe pattern, or through network servers, to achieve granular metering of IoT data exchanges.

%Secondly, we explore the use of blockchain technology and \textit{Smart Contracts} \cite{SMART-CONTRACTS} to remove the need for centralised trust. We discuss the challenges and limitations of using Smart Contracts for automatic dispute resolution.

%Finally, we present a prototype realisation of the marketplace, using MQTT brokers for granular data exchange with added traffic metering capabilities, and the Ethereum Smart Contracts technology for enforcing the contracts definition and providing dispute resolution capabilities.

%In our initial evaluation we show that smart contracts are indeed a viable option for validation of contract compliance, and assess its capability to handle a stream of blockchain transactions at varying arrival rate.

The paper presents an approach to addressing some of the challenges arising when trying to realise such a decentralised trust IoT data marketplace, by putting forth the following contributions:
\begin{itemize}
\item{We present an architecture for tracking data flows through a typical IoT infrastructure, which embodies a methodology to achieve granular metering of IoT data exchanges.}
\item{We explore the use of blockchain technology and smart contracts \cite{SMART-CONTRACTS} to remove the need for a centralised trust, account for data exchanges, achieve settllement, and resolve conflicts. Therefore, we discuss the challenges and lesson learnt from using smart contracts for automatic dispute resolution.}
\item{We evaluate our approach with a realistic prototype of a marketplace, using an MQTT broker for granular data exchange and added traffic metering capabilities, and the Ethereum smart contracts technology for enforcing the contracts definition and providing dispute resolution capabilities. We demonstrate the feasibility of the approach by determining the price of digital assets--with respect to the number and frequency of transactions--that would make it economically sustainable.
	\ag{check coherence with evaluation section.}
}\end{itemize}

The results of our evaluation shows that smart contracts are indeed a viable option for the validation of contract compliance, and assess its capability to handle a stream of blockchain transactions at varying arrival rate.
\ag{Probably add something else to wrap up the section. Also, probably move the text above in the last contribution point}

\subsection{Background and Related work}

%%%%
% sensors as service
%%%%
%\note{   \cite{Perera2014}  Perera, C., Zaslavsky, A., Christen, P., \& Georgakopoulos, D. (2014). Sensing as a service model for smart cities supported by Internet of Things. Transactions on Emerging Telecommunications Technologies, 25(1), 81–93. https://doi.org/10.1002/ett.2704}

%\note{ \cite{distefano2012sensing}  Distefano, S., Merlino, G., \& Puliafito, A. (2012). Sensing and actuation as a service: A new development for clouds. In Network Computing and Applications (NCA), 2012 11th IEEE International Symposium on (pp. 272–275). }

%\note{Banerjee, P., Friedrich, R., Bash, C., Goldsack, P., Huberman, B., Manley, J., … Veitch, A. (2011). Everything as a Service: Powering the New Information Economy. Computer, 44(3), 36–43. https://doi.org/10.1109/MC.2011.67}

The idea of considering data from IoT sensors as tradeable assets is closely related to that of \textit{Sensing as a Service} (SaaS) models, or even \textit{Sensing and Actuation as a service} (SAaaS) \cite{distefano2012sensing}, themselves derivatives of the more general ``Everything as a Service'' (XAAS) cloud-based model for data exchange \cite{5719575}. Perera et al. \cite{Perera2014}, for instance, outline a vision of a near future for Smart Cities, where data streams emanating from pervasive Internet of Things sensors are accessible through services. The SaaS model consists of four conceptual layers: sensors and their owners, sensor publishers, service providers, and sensor data consumers. In this classification, our work is relevant to all of these agents, as it enables fair and metered data exchanges amongst sensors owners and publishers on one side, and sensor data consumers, on the other.


%%%%
%\note{related: data pricing}
%%%%
%\note{\cite{Li:2014:TPP:2691190.2691191} Li, C., Li, D. Y., Miklau, G., \& Suciu, D. (2014). A Theory of Pricing Private Data. ACM Trans. Database Syst., 39(4), 34:1--34:28. https://doi.org/10.1145/2691190.2691191}

%\note{\cite{7437020} Niyato, D., Hoang, D. T., Luong, N. C., Wang, P., Kim, D. I., \& Han, Z. (2016). Smart data pricing models for the internet of things: a bundling strategy approach. IEEE Network, 30(2), 18–25. https://doi.org/10.1109/MNET.2016.7437020}

%\note{related: trust management}
%\note{ \cite{Bao:2012:DTM:2378023.2378025} Bao, F., \& Chen, I.-R. (2012). Dynamic Trust Management for Internet of Things Applications. In Proceedings of the 2012 International Workshop on Self-aware Internet of Things (pp. 1–6). New York, NY, USA: ACM. https://doi.org/10.1145/2378023.2378025}

%\note{\cite{Yan2014a} Yan, Z., Zhang, P., \& Vasilakos, A. V. (2014). A survey on trust management for Internet of Things. Journal of Network and Computer Applications, 42, 120–134. https://doi.org/10.1016/j.jnca.2014.01.014}
%

Our traffic monitoring infrastructure assumes that suitable pricing models that associate values to messages are in place.
However, it is agnostic and ``orthogonal'' to the specific pricing model, as long as the price of a complex bundle of data offering can be expressed in terms of unit cost associated to individual messages. 
Thus, in principle, any of the existing models for data pricing may be used in combination with traffic metering. Such models, recently proposed, range from theoretical frameworks for assigning prices to query answers as a function of their accuracy \cite{Li:2014:TPP:2691190.2691191}, to adaptations of \textit{Smart Data Pricing} \cite{Sen:2015:SDP:2847579.2756543} to the dynamic pricing of IoT data, such as personal data from wearable sensors \cite{7437020}.

A trust management model should also be established, i.e., to enable self-regulation of marketplace rules as we briefly discuss at the end of the paper.
Again, while this is out of our scope, existing frameworks can be used on top of out infrastructure.
Yan et al \cite{Yan2014a} provide a starting point, by exploring the notion of trust across the IoT platform layers (physical sensing, network, and application layer), with focus on  a wide range of properties from security to goodness, strength, reliability, availability, ability of data. Interestingly, however, their survey largely overlooks issues of trust amongst participants in a data marketplace, i.e., in the context of data exchange transactions.

%\note{ Roman, D., \& Stefano, G. (2016). Towards a Reference Architecture for Trusted Data Marketplaces: The Credit Scoring Perspective. In 2016 2nd International Conference on Open and Big Data (OBD) (pp. 95–101). IEEE. https://doi.org/10.1109/OBD.2016.21}
More directly useful in our setting, as we progress in our work, is Roman and Gatti's study of trust in data marketplaces \cite{7573695}, based on \textit{credit scoring}, where a direct connection is made to the use of blockchain technology in connection with data trading.

%%%%
%\note{related: marketplace for data}
%%%%

Two technical architectures for data marketplaces are directly relevant to our work.
%\note{ Schomm, F., Stahl, F., \& Vossen, G. (2013). Marketplaces for Data: An Initial Survey. SIGMOD Rec., 42(1), 15–26. https://doi.org/10.1145/2481528.2481532}
%\note{\cite{Cao:2016:MMR:2926746.2883611}  Cao, T.-D., Pham, T.-V., Vu, Q.-H., Truong, H.-L., Le, D.-H., \& Dustdar, S. (2016). MARSA: A Marketplace for Realtime Human Sensing Data. ACM Trans. Internet Technol., 16(3), 16:1--16:21. https://doi.org/10.1145/2883611}
Firstly the MARSA platform \cite{Cao:2016:MMR:2926746.2883611}, designed specifically to deal with real-time data streams by interacting with existing IoT platforms.
The motivation for this work is very similar to ours, namely to provide a marketplace where owners have an incentive to trade their data, for either personal or community benefit.
The many technical requirements that emerge from analysis of data marketplace potential translate into a complex architecture, which includes data flow orchestration, participants registration, data contract management, and payment.  
While these components do address complex marketplace requirements, our main challenge, namely to remove the need for a central trusted authority to manage the marketplace and ensure its fairness, remains unique to our work.

Secondly, Misura, K., \& Zagar \cite{7765669} focus on a query-based mechanism, whereby devices register their data supply capabilities to a broker along with a number of properties, and consumers express interest in data streams by querying those properties. The broker then connects the supplier stream to the consumer, and monitors usage. 
This is relevant work, as this type of matching of consumer data requirements to suppliers capabilities is more sophisticated than simple topic subscription. Our work is complementary to this  and also contributes to remove the trust from the broker for monitoring usage.
In our future work. we plan to move away from a fine-grained data subscription and towards complex data contracts (bundles), as discussed briefly at the end of the paper.
%\note{ Misura, K., \& Zagar, M. (2016). Data marketplace for Internet of Things. In 2016 International Conference on Smart Systems and Technologies (SST) (pp. 255–260). IEEE. https://doi.org/10.1109/SST.2016.7765669}
%\note{\cite{7146004} Blazquez, A., Tsiatsis, V., \& Vandikas, K. (2015). Performance Evaluation of OpenID Connect for an IoT Information Marketplace. In 2015 IEEE 81st Vehicular Technology Conference (VTC Spring) (pp. 1–6). IEEE. https://doi.org/10.1109/VTCSpring.2015.7146004}	

\textcolor{blue}{\section{Brokered IoT data as tradeable assets}}

We now present our conceptual model for the specification and enforcement of streamed data exchange agreements.
%
Following common IoT infrastructures, we are going to assume that data exchanges are mediated by one or more brokers.
Initially we assume the brokers are trusted. In Sec. \ref{sec:no-trust} we are going to explore the consequences of relaxing this assumption.

\subsection{Contracts and pricing}

Let  $P = \{p_1 \dots p_n \}$ and $C = \{ c_1 \dots c_m \}$ denote the set of producers (IoT devices) and consumers (VAS) that participate in the marketplace, respectively.
%
In the standard publish/subscribe model for data brokering, the $p_i$ act as publishers and the $c_j$ are subscribers.
These participants agree on a set $T = \{ t_1 \dots t_r \}$ of topics.
In IoT data brokering, messages are generated by gateways, which are responsible for segmenting raw data streams from edge devices into discrete messages.
The topic associated with each message describes the type of data stream, for example ``heart rate'', ``GPS track'', ``glucose reading'', ``energy reading'', etc.

Suppose $ p_i $ publishes data on a set of topics $T_{i} \subset T$.
A consumer $ c_j  $ enters into a \textit{contractual agreements} with a producer $ p_i  $ by subscribing to a subset $T_{ij} \subset T_i$ of the topics available from $p_i$, possibly only for the duration of a time window $ W = [w_s, w_e] $.
Such an agreement is interpreted as ``$p_i$ agrees to let $c_j$ receive a copy of all its messages tagged with any $t \in T_{ij}$ during $W$, and $c_j$ agrees to pay a corresponding data exchange fee. 
The broker manages all subscriptions and is responsible for reliably delivering to $ c_j  $ a copy of each message that has a topic that $ c_j $ subscribes to.

Note that in the standard pub/sub model, publishers and subscribers are unaware of one another, and their interaction is entirely mediated by the broker. 
However, it is easy to to extend the model by assuming that the broker will only deliver messages from $ p_i $ to $ c_j $ if $ c_j $ has an active agreement (i.e., relative to $W$) with $ p_i $.\footnote{This can be easily realised in a MQTT-based broker, which we use in our reference implementation.}

%for instance by embedding a device name into a topic tree
%	
%	. When topics are into a hierarchy, 
%
%\textcolor{blue}{To enable explicit marketplace} interactions, we propose a variation of the model whereby every message topic embeds the publisher's ID, which in combination with MQTT's topic regular expressions capability enables a subscriber to selectively choose the stream they intend to license.
%For example, device ``1234'' may publish messages about a specific room's temperature using topic  \#/temperature/1234/living\_room\_temperature. 
%A subscriber may choose to subscribe to this specific topic, or to any  living\_room\_temperature message using expression \#/temperature/*/living\_room\_temperature, or to any generic temperature message from ``1234'' or from any publisher.

%Note incidentally that the model includes the case, not shown in the figure, where a VAS may aggregate data from multiple $ p_i $s and then publish this value-added data, enabling other VAS to license it. 
%In this case, a VAS is both a consumer and a producer.



%While a variety of pricing models have recently been proposed for digital assets in emerging data marketplace scenarios \note{CITE}, discussing how the marketplace sets the data prices is beyond the scope of this work. Instead, we are simply going to assume that each individual message is a digital asset with a constant unit value $\mathit{val}(t_k)$, which is determined solely by the message's topic $t_k$.
A variety of pricing models have recently been proposed for digital assets in emerging data marketplace scenario \cite{Sen:2015:SDP:2847579.2756543,Li:2014:TPP:2691190.2691191,7553037,7437020}.
While our infrastructure is agnostic to the specific data pricing model, in our evaluation (Sec.\ref{sec:evaluaton}) we study the cost overhead associated with the enforcement of the agreements, to determine the viability of a decentralised trust infrastructure economically sustainable, specifically when agreements are enforced using Smart Contract transactions.
We are therefore going to assume a basic pricing model where each individual message is has constant unit value $\mathit{val}(t_k)$, which is determined solely by the message's topic $t_k$. 

\subsection{Data traffic cubes and centralised settlement}

Contract enforcement and settlement involves calculating the total price associated with the messages that have been routed from each $ p_i $ to each $ c_j $ within each $W$.
Since we have assumed that the price is  determined only by the number of messages and the unit cost for each topic, this simply requires keeping a count of the number of messages about topic $t_k$ that originated from $p_i$ and reached $c_j$ during $W$, grouped by $ p_i $, $ c_j $, and $ t_k $.
We denote each of these counts as $N_{ijk}(W)$.

Generating these counts requires that the broker be capable of \textit{metering} all traffic, that is, of logging all messages.
The log consists of a set of tuples:
$ \{\langle p_i, c_j, t_k \rangle  \} $

At the end of each $W$, the log is aggregated over each $p_i \in P, c_j \in C, t_k \in T$, resulting in a set of tuples that we call a \textit{traffic cube}:
\begin{equation}\label{eq:cube}
\mathit{cube}(W) = \{ \langle p_i, c_j, t_k, N_{ijk}(W) \rangle \}_{p_i \in P, c_j \in C, t_k \in T}
\end{equation}

Here we borrow our terminology from \textcolor{blue}{OLAP} database practice where a  ``cube'' is a table with $ N $ attributes, in which the first $ N-1 $ attributes are  dimensions in a database schema (in our case, these are the Producers, \textcolor{blue}{Consumers}, and Topics) and the last is an aggregation over values in the database for each combination of the dimensions -- in our case, a count().
We use a matrix indexing notation to refer to specific cells in the cube, i.e.:
\[ \mathit{cube}(W)[p_i, c_j, t_k] = N_{ijk}(W) \] 
These cubes contain summaries of all data flows observed by a broker. Notice that they only contain \textit{metadata}, i.e., the counts, but not the content of the messages.
%
Note that the values in the cube may be sparse, i.e., $N_{ijk}(W) = 0$ whenever $c_j$ does not subscribe to $t_k$.

\textit{Settlement} is the process of calculating the total fee owed by each $ c_j $ to each $ p_i $ at the end of each $W$.
This is computed by suitably aggregating the counts in the cube, namely:
\begin{equation}
\mathit{fee}(c_j, p_i, W) = \sum_{t_k \in T} N_{ijk}(W) \cdot \mathit{val}(t_k)
\label{eq:balance}
\end{equation}
and the total profit for $ p_i  $ is
\begin{equation}
\mathit{reward}(p_i, W) = \sum_{c_j} \mathit{fee}(c_j, p_i, W)
\label{eq:reward}
\end{equation}

In the centralised scenario we have considered so far settlement is straightforward, as the broker is entrusted with generating accurate logging and thus complete and correct cubes.
Note that, under the same trust assumptions, settlement extends easily to a more realistic scenario where multiple brokers are deployed, each enhanced with the same logging capabilities and local traffic reporting service.

Hovever, settlement becomes challenging in an extended model where there is no assumption of trust in the broker.
In this case, fee calculation must rely on data traffic counts that are calculated independently by each participant, based on the portions of data flows that are visible to each of them, with the 
further complication that participants cannot be trusted to generate complete and correct cubes.
This de-centralised scenario is illustrated in Fig. \ref{fig:iot-tracking-arch-2} and discussed in the next Section.

\section{Removing the need  for trust in the data flow network}  \label{sec:no-trust}

Any marketplace where the reward model is based on message counts is vulnerable to malicious behaviour by any of the participants. Specifically, the suppliers (the publishers) have an incentive to claim to have produced more messages than they have in reality, while conversely, subscribers have an incentive to under-report the number of messages they receive.
%
If we remove the assumption that the broker(s) are trusted, we must also accept that they may be prepared to collude with any of the participants, and thus deliver traffic cubes that may not be correct or complete.
Discovering such collusions may not be possible when the broker is the only source of traffic counts available to the settlement service.  At the same time, resolving any disputes amongst pairs of participants requires a public and irrefutable record of the reported traffic.

To address these problems we rely on two over-arching principles: (1) \textcolor{blue}{personal responsibility} of each participant in the marketplace, which shall report their own counts of messages sent (publishers) or received (subscribers), and (2) transparency, whereby these reports are posted as part of immutable and verifiable blockchain transactions.
In practice, we propose a two-steps approach.
%

Firstly, we remove the assumption that traffic cubes are generated by the broker alone, and instead enable networks elements close to the publishers and to the subscribers, i.e., gateways and VAS respectively, to generate the cubes.
%
Secondly, we adopt emerging consensus-based distributed transaction ledgers, specifically blockchain and Smart Contract technology, to realise the settlement service.
As we explain in more detail later (Sec. \ref{sec:blockchain}), Smart Contracts extend the standard blockchain transaction model by adding the capability to execute arbitrary code, which operates on data structures contained in the transaction itself. 
In this case, a transaction that is initiated at the end of each window $W$ may operate on the traffic cubes that participants make available at the end of $W$.
This  approach provides at the same time transparency and accountability, because the content of the blockchain is public and can be inspected, and a way to address disputes, because for each window W, multiple (partial) views of each cube are made available to the settlement service.

\subsection{Unilateral traffic cubes} \label{sec:u-cubes}
\ag{This sub-section now includes the architecture. It should be integrated in the previous main Section}
Traffic cubes that are generated by the broker summarise the entire traffic during $W$.
In contrast, traffic summaries generated by marketplace participants reflect the \textit{local} views of each participant in the data exchanges.
These are therefore necessarily partial and incomplete, as each participant, unlike the broker, has no visibility of the end-to-end data flows. 
We denote these as \textit{unilateral} traffic cubes, defined as follows.

We assume that a producer does not know which VAS subscribe to its stream, while subscribers, in contrast, know the source of the messages they receive. 
Let $\mathit{sub}(t_k) \subseteq C $ denote the set of subscribers to $t_k$.

A \textit{publisher's cube} $\mathit{cube^p}$ is a slice of a complete traffic cube, for a specific producer $p_i$ and without the consumer dimension:
\textcolor{green}{\[
\mathit{cube}^p(W, p_i)  =  \{ \langle t_k,  N^s_{ik}(W) \rangle \}_{t_k \in T}
\]}
where $N^s_{ik}(W)$ is the count of messages with topic $t_k$ sent by $p_i$ during $W$.

As subscribers know the source of the messages they receive, we may assume that a subscriber will produce summary reports that include the publisher dimension, but which only contain the tuples that pertain to a single $c_j$. We refer to this as a \textit{subscriber's cube}, $ \mathit{cube^s} $, defined as follows:
\[
\mathit{cube^s}(W, c_j)  =  \{ \langle p_i, t_k, N_{ijk}(W) \rangle | c_j \in \mathit{sub}(t_k)\}_{p_i \in P, t_k \in T}
\]

\begin{figure*}[!ht]
	\centering
	\includegraphics[width=0.8\textwidth]{figures/IoT-tracking-arch-2}
	\caption{Reference architecture for decentralised IoT data traffic metering based on blockchain and Smart Contracts}
	\label{fig:iot-tracking-arch-2}
\end{figure*}

Figure 1 concretely illustrates this setting. To remove the need for a centralised trust, we push it towards the borders of the data flow network by defining two trusted zones. The first trusted zone includes all the elements lying at the edge of the network infrastructure, such as the IoT devices (producers, Pi) and the gateways (Gi), whereas the second one includes the VASs (consumers, Ci). The latter range from monitoring, to health applications, assets tracking, smart city applications, etc. IoT data are still routed towards the VASs through brokers--using a publish-subscribe pattern--or network servers. However, we now assume that a new, independent component, namely the IoT data tracking component\ag{check naming wrt implementation section}, receives the unilateral cubes by gateways and VASs. Finally, a Smart Contract deployed on a blockchain periodically accesses the traffic cubes to realize settlement services and resolve possible conflicts.

\subsection{Consistency and settlement with unilateral cubes}

Suppose that, at the end of $W$, every $p_i$ and $c_j$ produce  unilateral cubes relative to $W$. 
These form the set
\begin{equation}\label{eq:all-cubes}
\{ \mathit{cube}^p(W, p_i) \}_{p_i \in P}\cup \{\mathit{cube^s}(W, c_j) \}_{c_j \in C} 
\end{equation}
As each of these cubes provides a partial view of the same complete cube that would have been generated centrally by a broker, we expect that the values found in these cubes must somehow be consistent with such global cube.

The pub/sub model implies that the number of messages sent by $p_i$ with topic $t_k$ during $W$ must be equal (assuming no messages are lost and ignoring duplicate transmissions) to the number of messages each $c_i$ that subscribes to $t_k$ receives from $p_i$. 
We can capture this constraint formally using our cubes notation, as follows.
%
For each $ p_i \in P, t_k \in T, c_j \in \mathit{sub}(t_k)$:
\textcolor{green}{\begin{equation}\label{eq:cubes-consistency}
\begin{split}
& \mathit{cube}^p(W, p_i)[t_k] = N^s_{ik}(W) = \\
& \mathit{cube}(W)[p_i, t_k, c_j]  = N_{ijk}(W) = \\
& \mathit{cube^s}(W, c_j)[p_i, t_k]
\end{split}
\end{equation}}

%\begin{definition}
We say that the set (\ref{eq:all-cubes}) of all unilateral cubes is \textit{consistent} at $W$, if and only their contents satisfy constraint (\ref{eq:cubes-consistency}).
%\begin{end}
We use this definition as a basis for settlement of message exchanges within each $W$, in the general case that the broker cannot be trusted to provide a single global cube that is complete and correct.
%
Specifically, in our architecture we  now assume that a new, independent component receives all cubes in (\ref{eq:all-cubes}) at the end of each $W$, and checks their consistency using (\ref{eq:cubes-consistency}). 
In the next section we discuss a practical implementation of this idea, where this new component is realised as a Ethereum Smart Contract and unilateral cubes are posted publicly as part of blockchain transactions. As explained in more detail later, a Smart Contract is a script that operates on the blockchain. It can be viewed as a third party trusted service, because its implementation is transparent and agreed upon by all marketplace participants. 

In this decentralised scenario, such a settlement service must be able to deal with two inter-dependent issues, namely (1) \textit{completeness} and (2) \textit{consistency} of the set (\ref{eq:all-cubes}) of all cubes.

The case when set (\ref{eq:all-cubes}) is both complete and consistent is straightforward and results in successful settlement, as all information for settlement is available, and there are no disagreements.

When the set of cubes is incomplete, we may try to use (\ref{eq:cubes-consistency}) to propagate missing values from the more complete to the less complete cubes. 
More precisely, suppose $ \mathit{cube}^p(W, p_i) $ is missing for a $p_i$.
If $ N_{ijk}(W) = \mathit{cube^s}(W, c_j)[p_i, t_k] $ is available for some $t_k$ and some $ c_j \in \mathit{sub}(t_k) $, then we set $  \mathit{cube}^p(W, p_i)[t_k]=  N_{ijk}(W) $.
In practice, this can be viewed as ``taking $ c_j $s word for $p_i$s missing report''.

Symmetrically, the settlement service may use the available $ \mathit{cube}^p(W, p_i)$, in combination with subscription information $ \{\mathit{sub}(t_k) | t_k \in T \}$, to fill in missing values in 
$  \mathit{cube^s}(W, c_j)  $, i.e., by setting 
$ \mathit{cube^s}(W, c_j)[p_i, t_k]  =  \mathit{cube}^p(W, p_i)[t_k]$ for each $t_k$ and each $c_j \in \mathit{sub}(t_k)$.

Of course, there is no guarantee that all missing values can be propagated. 
In this case, settlement for the $\langle p_i, c_j \rangle$ pairs corresponding to the missing cube entries is simply not possible.

The final, and perhaps more important case occurs when constraint (\ref{eq:cubes-consistency}) is violated for some combination of $\langle p_i, c_j, t_k \rangle$.
This may occur because producers have an incentive to over-report the number of messages they sent, while symmetrically, subscribers have an incentive to under-report the number of messages they received.

Either of these malicious scenarios manifests itself as inequalities in (\ref{eq:cubes-consistency}), of the form:
\begin{equation}\label{eq:inconsistencies}
\mathit{cube}^p(W, p_i)[t_k] > \mathit{cube^s}(W, c_j)[p_i, t_k]
\end{equation}
In this situation, we are able to detect the inconsistency, but we may not have enough information to determine whether $p_i$, $c_j$, or both are guilty of malicious behaviour.
Such determination is beyond the scope of this paper, but in the final discussion section we present initial ideas on promoting a self-regulating marketplace in the presence of malicious behaviour.

In our initial implementation, described in the next section, the settlement service simply reports the detected inequalities.

%%%%
%%% Andrea + Angelo
\input{realisation}
%%%%


\section{Conclusion and future work}




% conference papers do not normally have an appendix


% use section* for acknowledgment
\section*{Acknowledgment}


The authors would like to thank...

\bibliographystyle{IEEEtran}
\bibliography{IEEEabrv,iot-conf}



% trigger a \newpage just before the given reference
% number - used to balance the columns on the last page
% adjust value as needed - may need to be readjusted if
% the document is modified later
%\IEEEtriggeratref{8}
% The "triggered" command can be changed if desired:
%\IEEEtriggercmd{\enlargethispage{-5in}}

% references section

% can use a bibliography generated by BibTeX as a .bbl file
% BibTeX documentation can be easily obtained at:
% http://mirror.ctan.org/biblio/bibtex/contrib/doc/
% The IEEEtran BibTeX style support page is at:
% http://www.michaelshell.org/tex/ieeetran/bibtex/
%\bibliographystyle{IEEEtran}
% argument is your BibTeX string definitions and bibliography database(s)
%\bibliography{IEEEabrv,../bib/paper}
%
% <OR> manually copy in the resultant .bbl file
% set second argument of \begin to the number of references
% (used to reserve space for the reference number labels box)




% that's all folks
\end{document}


